# Base patches:
#  http://cgit.openembedded.org/openembedded-core/tree/meta/recipes-bsp/pciutils/pciutils/configure.patch?h=morty
#  http://cgit.openembedded.org/openembedded-core/tree/meta/recipes-bsp/pciutils/pciutils/guess-fix.patch?h=morty
#
# This patch:
#  * ensures the link correctly
#  * disable strip
#  * allows to optionally pass target information to configure rather than using uname
#  * select linux as the platform in most cases we care about
diff -Naur a/Makefile b/Makefile
--- a/Makefile	2015-05-07 17:34:48.691676068 +0000
+++ b/Makefile	2015-05-07 17:47:14.739676071 +0000
@@ -41,7 +41,6 @@
 # Commands
 INSTALL=install
 DIRINSTALL=install -d
-STRIP=-s
 CC=$(CROSS_COMPILE)gcc
 AR=$(CROSS_COMPILE)ar
 RANLIB=$(CROSS_COMPILE)ranlib
@@ -99,7 +98,7 @@
 example.o: example.c $(PCIINC)
 
 %: %.o
-	$(CC) $(LDFLAGS) $(TARGET_ARCH) $^ $(LDLIBS) -o $@
+	$(CC) $(LDFLAGS) $(TARGET_ARCH) $^ $(LIB_LDLIBS) -o $@
 
 lspci-udeb: lspci.o
 	$(CC) $(LDFLAGS) $(TARGET_ARCH) $^ $(LDLIBS) -lz -lresolv -o $@
@@ -118,8 +117,7 @@
 install: all
 # -c is ignored on Linux, but required on FreeBSD
 	$(DIRINSTALL) -m 755 $(DESTDIR)$(SBINDIR) $(DESTDIR)$(IDSDIR) $(DESTDIR)$(MANDIR)/man8 $(DESTDIR)$(MANDIR)/man7
-	$(INSTALL) -c -m 755 $(STRIP) lspci setpci $(pcimod-1) $(DESTDIR)$(SBINDIR)
-	$(INSTALL) -c -m 755 $(STRIP) lspci-udeb $(DESTDIR)-udeb$(SBINDIR)/lspci
+	$(INSTALL) -c -m 755 lspci setpci $(pcimod-1) $(DESTDIR)$(SBINDIR)
 	$(INSTALL) -c -m 755 update-pciids $(DESTDIR)$(SBINDIR)
 	$(INSTALL) -c -m 644 $(PCI_IDS) $(DESTDIR)$(IDSDIR)
 	$(INSTALL) -c -m 644 lspci.8 setpci.8 update-pciids.8 $(pcimod8-1) $(DESTDIR)$(MANDIR)/man8
diff --git a/lib/configure b/lib/configure
index 27388bc..1c7c454 100755
--- a/lib/configure
+++ b/lib/configure
@@ -14,6 +14,10 @@ echo_n() {
 	fi
 }
 
+VERSION=$1
+IDSDIR=$2
+DNS=yes
+
 if [ -z "$VERSION" -o -z "$IDSDIR" ] ; then
 	echo >&2 "Please run the configure script from the top-level Makefile"
 	exit 1
@@ -21,8 +25,8 @@ fi
 
 echo_n "Configuring libpci for your system..."
 if [ -z "$HOST" ] ; then
-	sys=`uname -s`
-	rel=`uname -r`
+	sys=${3:-`uname -s`}
+	rel=
 	realsys="$sys"
 	if [ "$sys" = "AIX" -a -x /usr/bin/oslevel -a -x /usr/sbin/lsattr ]
 	then
@@ -30,7 +34,7 @@ if [ -z "$HOST" ] ; then
 		proc=`/usr/sbin/lsdev -C -c processor -S available -F name | head -1`
 		cpu=`/usr/sbin/lsattr -F value -l $proc -a type | sed 's/_.*//'`
 	else
-		cpu=`uname -m | sed 's/^i.86$/i386/;s/^sun4u$/sparc64/;s/^i86pc$/i386/;s/^BePC$/i386/;s/^BeMac$/powerpc/;s/^BeBox$/powerpc/'`
+		cpu=${4:-`uname -m | sed 's/^i.86$/i386/;s/^sun4u$/sparc64/;s/^i86pc$/i386/;s/^BePC$/i386/;s/^BeMac$/powerpc/;s/^BeBox$/powerpc/'`}
 	fi
 	if [ "$sys" = "GNU/kFreeBSD" -o "$sys" = "DragonFly" ]
 	then
@@ -40,13 +44,15 @@ if [ -z "$HOST" ] ; then
 	then
 		sys=cygwin
 	fi
-	HOST=${3:-$cpu-$sys}
+	HOST=$cpu-$sys
 fi
 [ -n "$RELEASE" ] && rel="${RELEASE}"
 # CAVEAT: tr on Solaris is a bit weird and the extra [] is otherwise harmless.
 host=`echo $HOST | sed -e 's/^\([^-]*\)-\([^-]*\)-\([^-]*\)-\([^-]*\)$/\1-\3/' -e 's/^\([^-]*\)-\([^-]*\)$/\1--\2/' | tr '[A-Z]' '[a-z]'`
 cpu=`echo $host | sed 's/^\([^-]*\)-\([^-]*\)-\(.*\)$/\1/'`
 sys=`echo $host | sed 's/^\([^-]*\)-\([^-]*\)-\(.*\)$/\3/'`
+
+{ echo "$host" | grep -q linux; } && sys=linux
 echo " $host $rel $cpu $sys"
 
 c=config.h
